# README

Приложение "Placeholder_ftp" выполняет преобразования файлов сетевого трафика в текстовый формат по анаологии с TShark.
Выполняет действия в следующем порядке:

1. Принимает команду в виде JSON объекта, структура JSON объекта подробно описана ниже, через брокер сообщения NATS.
2. Забирает по указанному пути с локального ftp сервера, pcap файл, с фрагментом сетевого трафика.
3. Преобразует полученный pcap файл в текстовый формат, результат преобразования похож на файл полученный в результате
   обработки файла pcap программой TShark.
4. Отправляет полученный текстовый файл на ftp сервер-агрегатор по заданному в полученном JSON пути.
5. Отправляет JSON объект с ответом инициатору запроса.

## Конфигурационные настройки

Конфигурационные параметры для сервиса могут быть заданы как через конфигурационный файл так и методом установки переменных окружения. Однако, все пароли и
ключевые токены, используемые для авторизации, задаются ТОЛЬКО через переменные окружения.

#### Типы конфигурационных файлов:

- config.yaml общий конфигурационный файл
- config_dev.yaml конфигурационный файл используемый для тестов при разработке
- config_prod.yaml конфигурационный файл применяемый в продуктовом режиме

Основная переменная окружения для данного приложения - GO_PHFTP_MAIN. На основании значения этой переменной принимается решение какой из конфигурационных файлов config_dev.yaml или config_prod.yaml использовать. При GO_PHFTP_MAIN=development будет использоваться config_dev.yaml, во всех остальных случаях, в том числе и при отсутствии переменной окружения GO_PHFTP_MAIN будет использоваться конфигурационный файл config_prod.yaml. Перечень переменных окружения которые можно использовать для настройки приложения:

#### Переменная окружения отвечающая за тип запуска приложения "test", "development" или "production"

- GO_PHFTP_MAIN

#### Переменные окружения отвечающие за подключение к NATS

- GO_PHFTP_NPREFIX
- GO_PHFTP_NHOST
- GO_PHFTP_NPORT
- GO_PHFTP_NCACHETTL - данный параметр должен содержать время жизни записи
  кэша, по истечение которого запись автоматически удаляется, значение задается
  в секундах в диапазоне от 10 до 86400 секунд
- GO_PHFTP_NSUBLISTENERCOMMAND - канал для приема команд

#### Переменные окружения отвечающие за подключение к локальному FTP сервреру

- GO_PHFTP_LOCALFTP_HOST
- GO_PHFTP_LOCALFTP_PORT
- GO_PHFTP_LOCALFTP_USERNAME
- GO_PHFTP_LOCALFTP_PASSWD

#### Переменные окружения отвечающие за подключение к FTP сервреру агрегатору файлов

- GO_PHFTP_MAINFTP_HOST
- GO_PHFTP_MAINFTP_PORT
- GO_PHFTP_MAINFTP_USERNAME
- GO_PHFTP_MAINFTP_PASSWD

#### Переменные окружения отвечающие за настройки доступа к БД в которую будут записыватся логи

- GO_PHFTP_DBWLOGHOST // доменное имя или ip БД
- GO_PHFTP_DBWLOGPORT // порт БД
- GO_PHFTP_DBWLOGNAME // наименование БД (при необходимости)
- GO_PHFTP_DBWLOGSTORAGENAME // наименование объекта хранения логов (таблица, документ, индекс и т.д. зависит от типа БД)
- GO_PHFTP_DBWLOGUSER // пользователь БД
- GO_PHFTP_DBWLOGPASSWD // пароль для доступа к БД

Настройки логирования данных в БД не являются обязательными и необходимы только если пользователь приложения желает хранить логи в базе данных

Приоритет значений заданных через переменные окружения выше чем значений полученных из конфигурационных файлов.

## Структура JSON запроса

```
{
	"task_id": "", //идентификатор задачи
  "source": "", //наименование регионального объекта к которому был адресован запрос
	"service": "test_service", //имя сервиса-инициатора команды
	"command": "convert_and_copy_file", //наименование команды
	"parameters": {
		"path_local_ftp": "/net_traff", //путь к папке на локальном ftp сервере
 		"path_main_ftp": "/net_traff_txt", //путь к целевой папке на ftp сервере-агрегаторе
		"files": ["test_pcap_file.pcap", "test_pcap_file_http.pcap"] //список файлов которые необходимо обработать
	}
}
```

Выполняются следующие типы команд:

- 'copy_file' просто выполняет копирование файла с одного ftp сервера на другой
- 'convert_and_copy_file' выполняется конвертирование pcap файла в текст и копирование с одного ftp сервера на другой

## Структура JSON ответа

Для получения ответа на запрос необходимо слушать 'временную тему' сообщения NATS.

```
{
  "request_id":"", //идентификатор задачи
  "source": "", //наименование регионального объекта к которому был адресован запрос
  "error": "", //содержит глобальные ошибки, такие как например, ошибка подключения к ftp серверу
  "status_code": "", //код статуса выполнения задачи
  "processed_files": [
    {
      "file_name_old": "" //старое имя файла
      "file_name_new": "" //новое имя файла (которое формируется на основе старого, после обработки файла декодером)
      "error": "" //ошибка возникшая при обработки файла
      "size_befor_processing": int //размер файла до обработки
      "size_after_processing": int //размер файла после обработки
    }
  ]
}
```
